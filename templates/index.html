<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StVO Traffic Inspector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- jsPDF f√ºr PDF-Generierung (Bu√ügeldbescheid + Widerspruch) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i data-lucide="shield-check" class="text-white w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight" id="header-title">StVO Traffic Inspector</h1>
                    <p class="text-xs text-slate-400 uppercase tracking-wider font-semibold" id="header-subtitle">German Traffic Law AI</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center bg-slate-800 rounded-lg p-1 border border-slate-700">
                    <button onclick="inspector.setLanguage('de')" id="btn-de" class="px-3 py-1.5 rounded-md text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700">DE</button>
                    <button onclick="inspector.setLanguage('en')" id="btn-en" class="px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-blue-600 text-white shadow-sm">EN</button>
                </div>
            </div>
        </div>
    </header>

    <main class="px-4 py-8 min-h-[calc(100vh-140px)] flex flex-col items-center">

        <!-- Intro Section -->
        <div id="intro-section" class="text-center mb-8 animate-fade-in max-w-2xl">
            <h2 class="text-3xl font-bold text-slate-800 mb-3" data-t="introTitle">German Traffic Inspector</h2>
            <p class="text-slate-600">
                <span data-t="introDescStart">Upload dashcam footage or photos to check for compliance with the</span>
                <span class="font-semibold text-blue-700">Stra√üenverkehrs-Ordnung (StVO)</span>.
            </p>
        </div>

        <!-- Upload Interface -->
        <div id="upload-container" class="w-full max-w-xl transition-all duration-500">
            <div id="drop-zone" class="relative group flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-slate-300 rounded-2xl bg-white hover:bg-slate-50 transition-all cursor-pointer overflow-hidden">
                <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="image/*,video/*">

                <div id="upload-ui" class="flex flex-col items-center justify-center pt-5 pb-6 text-center px-4 pointer-events-none">
                    <div class="p-4 rounded-full bg-slate-100 mb-4 group-hover:bg-blue-50 transition-colors">
                        <i data-lucide="upload" class="w-10 h-10 text-slate-400 group-hover:text-blue-500"></i>
                    </div>
                    <p class="mb-2 text-lg font-semibold text-slate-700" data-t="dropMain">Drop evidence here</p>
                    <!-- Hinweis: ohne (max 20MB) im UI -->
                    <p class="mb-4 text-sm text-slate-500" data-t="dropSub">Upload photos or videos</p>
                </div>

                <!-- Loading Overlay -->
                <div id="loading-overlay" class="hidden absolute inset-0 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center text-white z-20">
                    <i data-lucide="loader-2" class="w-12 h-12 animate-spin text-blue-500 mb-4"></i>
                    <h3 class="text-xl font-bold" data-t="analyzing">Analyzing Scene...</h3>
                    <p class="text-slate-300 text-sm mt-2" data-t="analyzingSub">Checking StVO Database</p>
                </div>
            </div>

            <!-- File info + Analyze button -->
            <div class="mt-4 flex items-center justify-between">
                <div id="file-info" class="text-sm text-slate-600 hidden">
                    <span data-t="fileSelected">Ausgew√§hlte Datei:</span>
                    <span id="file-name" class="font-medium break-all ml-1"></span>
                </div>
                <button
                    id="analyze-btn"
                    onclick="inspector.startAnalysis()"
                    class="flex items-center gap-2 bg-blue-400 text-white px-5 py-2 rounded-lg font-semibold shadow-sm opacity-60 cursor-not-allowed transition-colors"
                    disabled
                >
                    <i data-lucide="scan-search" class="w-4 h-4"></i>
                    <span data-t="analyzeBtn">Analyse starten</span>
                </button>
            </div>
        </div>

        <!-- Results Interface (Single Column Layout) -->
        <div id="results-container" class="hidden w-full max-w-4xl mt-8 animate-fade-in space-y-8">

            <!-- 1. Evidence Display -->
            <div class="bg-black rounded-xl overflow-hidden shadow-2xl border border-slate-800">
                <div class="p-2 bg-slate-900 text-white text-sm font-bold flex items-center gap-2">
                     <i data-lucide="eye" class="w-4 h-4"></i> <span data-t="evidenceMedia">Evidence Media</span>
                </div>
                <div class="flex justify-center bg-black">
                    <img id="result-img" class="hidden w-full max-h-[500px] object-contain" />
                    <video id="result-video" class="hidden w-full max-h-[500px] object-contain" controls></video>
                </div>
            </div>

            <!-- 2. Proof Frame (If Video & Violation) -->
            <div id="proof-card" class="hidden bg-white rounded-xl overflow-hidden shadow-lg border border-red-100">
                 <div class="p-3 bg-red-50 border-b border-red-100 font-bold text-red-800 flex items-center gap-2">
                    <i data-lucide="camera" class="w-4 h-4"></i>
                    <!-- ohne Klammern -->
                    <span data-t="proofFrame">Proof of Violation</span>
                 </div>
                <div class="bg-black p-1 flex justify-center">
                    <img id="proof-img" class="max-h-[300px] object-contain" />
                </div>
            </div>

            <!-- 3. Action Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="inspector.downloadPDF()" class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-xl font-bold shadow-md transition-all transform hover:-translate-y-0.5">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    <span data-t="btnPdf">Download Penalty Notice (PDF)</span>
                </button>

                <button onclick="inspector.openAppealModal()" class="flex items-center justify-center gap-2 bg-white border-2 border-slate-200 hover:bg-slate-50 text-slate-700 py-3 px-6 rounded-xl font-bold shadow-sm transition-all transform hover:-translate-y-0.5">
                    <i data-lucide="gavel" class="w-5 h-5"></i>
                    <!-- ohne "(Entwurf)" -->
                    <span data-t="btnAppeal">File Objection</span>
                </button>
            </div>

            <!-- 4. Analysis Report -->
            <div class="bg-white shadow-xl rounded-xl overflow-hidden border border-slate-200">
                <!-- Verdict Banner -->
<div id="verdict-banner" class="p-6 flex items-center justify-between bg-slate-500 text-white">
    <div class="flex items-center gap-4">
        <div id="verdict-icon-container"></div>
        <div>
            <h2 class="text-2xl font-bold uppercase tracking-wide" id="verdict-title">Title</h2>
            <p class="opacity-90 font-medium text-sm" data-t="verdict">StVO Assessment</p>
        </div>
    </div>

    <div class="text-right">
        <div class="text-sm opacity-75 uppercase font-bold tracking-wider" data-t="penaltyPoints">
            Fehlerpunkte
        </div>

        <div class="text-3xl font-black flex items-end justify-end gap-1">
            <span id="penalty-points-val">0</span>
            <span class="text-lg font-semibold opacity-75">/</span>
            <span id="penalty-points-max" class="text-lg font-semibold opacity-75">10</span>
            <span class="text-lg font-semibold opacity-75" data-t="penaltyPointsUnit">Pkt.</span>
        </div>
    </div>
</div>



                <div class="p-6 space-y-6">
                    <!-- Uncertainty Flags -->
                    <section id="uncertainty-flags-section" class="hidden">
                        <h3 class="text-slate-900 font-bold text-lg flex items-center gap-2 mb-3">
                            <i data-lucide="alert-triangle" class="text-amber-600 w-5 h-5"></i>
                            <span data-t="uncertaintyFlags">Analysis Uncertainties</span>
                        </h3>
                        <div class="flex flex-wrap gap-2" id="uncertainty-flags-container"></div>
                    </section>

                    <section>
                        <h3 class="text-slate-900 font-bold text-lg flex items-center gap-2 mb-3">
                            <i data-lucide="activity" class="text-blue-600 w-5 h-5"></i>
                            <span data-t="situation">Situation Analysis</span>
                        </h3>
                        <p id="situation-text" class="text-slate-600 leading-relaxed"></p>
                    </section>

                    <section id="violation-detail-box" class="hidden bg-red-50 rounded-lg p-4 border border-red-100">
                        <h3 class="text-red-900 font-bold text-lg mb-2" data-t="violationDetails">Violation Details</h3>
                        <p id="violation-text" class="text-red-800 text-sm leading-relaxed"></p>
                    </section>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <section>
                            <h3 class="text-slate-900 font-bold text-lg flex items-center gap-2 mb-3">
                                <i data-lucide="book-open" class="text-blue-600 w-5 h-5"></i>
                                <span data-t="regulations">Applied Regulations</span>
                            </h3>
                            <ul id="stvo-list" class="space-y-2"></ul>
                        </section>

                        <section>
                            <h3 class="text-slate-900 font-bold text-lg flex items-center gap-2 mb-3">
                                <i data-lucide="map-pin" class="text-blue-600 w-5 h-5"></i>
                                <span data-t="detectedObjects">Detected Objects</span>
                            </h3>
                            <div id="signs-list" class="space-y-2"></div>
                        </section>
                    </div>

                    <!-- Kleiner KI-Hinweis (DE/EN) -->
                    <p class="mt-4 text-xs text-slate-400 leading-snug" data-t="aiNotice">
                        Hinweis: Diese Auswertung wird automatisiert durch ein KI-System erzeugt und stellt keine Rechtsberatung oder verbindliche Entscheidung einer Beh√∂rde dar. Es wird keine Gew√§hr f√ºr Richtigkeit oder Vollst√§ndigkeit √ºbernommen.
                    </p>

                    <button onclick="inspector.reset()" class="mt-8 w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold rounded-lg transition-colors" data-t="analyzeNew">
                        Analyze Another Case
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Appeal Modal -->
    <div id="appeal-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full overflow-hidden transform transition-all scale-95 animate-fade-in">
            <div class="bg-slate-900 text-white p-4 flex justify-between items-center">
                <!-- ohne "Entwurf" -->
                <h3 class="font-bold text-lg" data-t="appealTitle">Objection Letter</h3>
                <button onclick="inspector.closeAppealModal()" class="hover:bg-slate-700 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-500 mb-4" data-t="appealIntro">Copy or download this text to formally object to the generated accusation.</p>
                <div class="bg-slate-50 p-4 rounded border border-slate-200 font-mono text-sm text-slate-700 overflow-auto max-h-60" id="appeal-text" contenteditable="true"></div>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="inspector.closeAppealModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium" data-t="close">Close</button>
                    <button onclick="inspector.downloadAppealPDF()" class="px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700 rounded-lg font-medium flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> <span data-t="downloadAppealPdf">Download PDF</span>
                    </button>
                    <button onclick="inspector.copyAppeal()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg font-medium flex items-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i> <span data-t="copy">Copy Text</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================
         ü§ñ CHATBOT (NEU)
         - erscheint erst NACH Analyse
         ========================= -->

    <!-- Floating Button (wenn Chat minimiert) -->
    <button
        id="chatbot-fab"
        onclick="openChatbot()"
        class="hidden fixed bottom-6 right-6 w-14 h-14 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-2xl flex items-center justify-center z-50"
        title="Chatbot"
    >
        <i data-lucide="bot" class="w-6 h-6"></i>
    </button>

    <!-- Chat Panel -->
    <div
        id="chatbot-container"
        class="hidden fixed bottom-6 right-6 w-[380px] max-w-[92vw] bg-white border border-slate-200 rounded-2xl shadow-2xl flex flex-col overflow-hidden z-50"
    >
        <div class="flex items-center justify-between bg-slate-900 text-white px-4 py-3">
            <div class="flex items-center gap-2 font-bold">
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                <span data-t="chatTitle">StVO KI-Assistent</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="minimizeChatbot()" class="hover:text-slate-300" title="Minimieren">
                    <i data-lucide="minus" class="w-5 h-5"></i>
                </button>
                <button onclick="closeChatbot()" class="hover:text-slate-300" title="Schlie√üen">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div id="chatbot-messages" class="p-4 space-y-3 text-sm overflow-y-auto bg-slate-50" style="max-height: 360px;">
            <div id="chatbot-intro" class="text-slate-600">
                <span data-t="chatIntro">Frag mich alles zur Analyse, Paragraphen oder dem erkannten Versto√ü.</span>
            </div>
        </div>

        <div class="p-3 border-t bg-white">
            <div class="flex gap-2">
                <input
                    id="chatbot-input"
                    type="text"
                    placeholder="z. B. Warum ist das ein Versto√ü?"
                    class="flex-1 border border-slate-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200"
                    onkeydown="if(event.key==='Enter') sendChatbotMessage()"
                />
                <button
                    id="chatbot-send"
                    onclick="sendChatbotMessage()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-xl text-sm font-semibold"
                >
                    <span data-t="chatSend">Senden</span>
                </button>
            </div>
            <p class="mt-2 text-xs text-slate-400" data-t="chatHint">
                Tipp: ‚ÄûWelche StVO-Regel ist relevant?‚Äú oder ‚ÄûWie hoch ist das Bu√ügeld?‚Äú
            </p>
        </div>
    </div>

    <script>
        // Nur visuell erkennbare Verst√∂√üe (Option A)
        const OFFENCE_CATALOG = [
            {
                key: "SPEEDING",
                title: {
                    de: "Geschwindigkeits√ºberschreitung",
                    en: "Speeding offence"
                },
                legal: "¬ß3 StVO i.V.m. Bu√ügeldkatalog",
                fine: 70,
                points: 1,
                banMonths: 0
            },
            {
                key: "RED_LIGHT",
                title: {
                    de: "Rotlichtversto√ü",
                    en: "Red light violation"
                },
                legal: "¬ß37 StVO i.V.m. Bu√ügeldkatalog",
                fine: 200,
                points: 2,
                banMonths: 1
            },
            {
                key: "DISTANCE",
                title: {
                    de: "Abstandsversto√ü",
                    en: "Insufficient distance"
                },
                legal: "¬ß4 StVO",
                fine: 100,
                points: 1,
                banMonths: 0
            },
            {
                key: "RIGHT_OF_WAY",
                title: {
                    de: "Vorfahrt missachtet",
                    en: "Right of way violation"
                },
                legal: "¬ß8 StVO",
                fine: 120,
                points: 1,
                banMonths: 0
            },
            {
                key: "PEDESTRIAN",
                title: {
                    de: "Fu√üg√§nger gef√§hrdet",
                    en: "Endangering pedestrians"
                },
                legal: "¬ß26 StVO",
                fine: 80,
                points: 1,
                banMonths: 0
            },
            {
                key: "RAILWAY",
                title: {
                    de: "Versto√ü am Bahn√ºbergang",
                    en: "Railway crossing violation"
                },
                legal: "¬ß19 StVO",
                fine: 240,
                points: 2,
                banMonths: 1
            },
            {
                key: "SEATBELT",
                title: {
                    de: "Sicherheitsgurt nicht angelegt",
                    en: "Seat belt not fastened"
                },
                legal: "¬ß21a StVO",
                fine: 30,
                points: 0,
                banMonths: 0
            },
            {
                key: "MOBILE",
                title: {
                    de: "Handy am Steuer",
                    en: "Mobile phone while driving"
                },
                legal: "¬ß23 Abs. 1a StVO",
                fine: 100,
                points: 1,
                banMonths: 0
            },
            {
                key: "GENERIC",
                title: {
                    de: "Versto√ü gegen die StVO",
                    en: "Violation of the German Road Traffic Regulations"
                },
                legal: "StVO i.V.m. Bu√ügeldkatalog",
                fine: 55,
                points: 0,
                banMonths: 0
            }
        ];

        const TRANSLATIONS = {
            en: {
                headerTitle: "StVO Traffic Inspector",
                headerSubtitle: "German Traffic Law AI",
                introTitle: "German Traffic Inspector",
                introDescStart: "Upload dashcam footage or photos to check for compliance with the",
                dropMain: "Drop evidence here",
                dropSub: "Upload photos or videos",
                analyzing: "Analyzing Scene...",
                analyzingSub: "Checking StVO Database",
                verdict: "StVO Assessment",
                violationDetected: "Violation Detected",
                noViolation: "No Violation Detected",
                penaltyPoints: "Penalty Points",
                penaltyPointsUnit: "Pts",
                uncertaintyFlags: "Analysis Uncertainties",
                situation: "Situation Analysis",
                violationDetails: "Violation Details",
                regulations: "Applied Regulations (StVO)",
                detectedObjects: "Detected Objects",
                noObjects: "No traffic signs detected",
                analyzeNew: "Analyze Another Case",
                evidenceMedia: "Evidence Media",
                // ohne Klammern
                proofFrame: "Proof of Violation",
                btnPdf: "Download Penalty Notice (PDF)",
                // ohne "Draft"
                btnAppeal: "File Objection",
                // ohne "Draft"
                appealTitle: "Objection Letter",
                appealIntro: "Copy or download this text to formally object to the generated accusation.",
                close: "Close",
                copy: "Copy Text",
                downloadAppealPdf: "Download PDF",
                aiNotice: "Note: This analysis is generated automatically by an AI system and does not constitute legal advice or a binding decision by any public authority. No guarantee is given for accuracy or completeness; in case of doubt, only official decisions by authorities and courts are legally relevant.",
                analyzeBtn: "Start Analysis",
                fileSelected: "Selected file:",

                // ü§ñ Chatbot
                chatTitle: "AI Assistant",
                chatIntro: "Ask me anything about the analysis, paragraphs, or the detected offence.",
                chatSend: "Send",
                chatHint: "Tip: ‚ÄúWhich StVO rule applies?‚Äù or ‚ÄúHow high is the fine?‚Äù",
                chatPlaceholder: "e.g. Why is this a violation?"
            },
            de: {
                headerTitle: "StVO Verkehrs-Inspektor",
                headerSubtitle: "KI f√ºr Deutsches Verkehrsrecht",
                introTitle: "Deutscher Verkehrsrecht-Inspektor",
                introDescStart: "Laden Sie Dashcam-Aufnahmen oder Fotos hoch, um sie auf Einhaltung der",
                dropMain: "Beweismittel hier ablegen",
                dropSub: "Fotos oder Videos hochladen",
                analyzing: "Szene wird analysiert...",
                analyzingSub: "Extrahiere Bilder & pr√ºfe StVO",
                verdict: "StVO-Einsch√§tzung",
                violationDetected: "Versto√ü erkannt",
                noViolation: "Kein Versto√ü erkannt",
                penaltyPoints: "Fehlerpunkte",
                penaltyPointsUnit: "Pkt.",
                uncertaintyFlags: "Analyse-Unsicherheiten",
                situation: "Situationsanalyse",
                violationDetails: "Details zum Versto√ü",
                regulations: "Angewandte Vorschriften (StVO)",
                detectedObjects: "Erkannte Objekte",
                noObjects: "Keine Verkehrszeichen erkannt",
                analyzeNew: "Neuen Fall analysieren",
                evidenceMedia: "Beweis-Medium",
                // ohne Klammern
                proofFrame: "Beweisfoto",
                btnPdf: "Bu√ügeldbescheid herunterladen (PDF)",
                // ohne "(Entwurf)"
                btnAppeal: "Widerspruch einlegen",
                appealTitle: "Widerspruchsschreiben",
                appealIntro: "Kopieren oder laden Sie diesen Text herunter, um formell Widerspruch einzulegen.",
                close: "Schlie√üen",
                copy: "Text kopieren",
                downloadAppealPdf: "PDF herunterladen",
                aiNotice: "Hinweis: Diese Auswertung wird automatisiert durch ein KI-System erzeugt und stellt weder Rechtsberatung noch einen verbindlichen Bescheid einer Beh√∂rde dar. F√ºr Richtigkeit und Vollst√§ndigkeit wird keine Gew√§hr √ºbernommen; im Zweifel ma√ügeblich sind ausschlie√ülich die Entscheidungen der zust√§ndigen Beh√∂rden und Gerichte.",
                analyzeBtn: "Analyse starten",
                fileSelected: "Ausgew√§hlte Datei:",

                // ü§ñ Chatbot
                chatTitle: "StVO KI-Assistent",
                chatIntro: "Frag mich alles zur Analyse, Paragraphen oder dem erkannten Versto√ü.",
                chatSend: "Senden",
                chatHint: "Tipp: ‚ÄûWelche StVO-Regel ist relevant?‚Äú oder ‚ÄûWie hoch ist das Bu√ügeld?‚Äú",
                chatPlaceholder: "z. B. Warum ist das ein Versto√ü?"
            }
        };

        class TrafficInspector {
            constructor() {
                this.lang = 'de';
                this.currentResult = null;
                this.analysisId = null;
                this.proofFrame = null;    // Base64 des Beweisfotos
                this.penalty = null;       // berechnetes Bu√ügeld-Objekt
                this.selectedFile = null;  // zuletzt hochgeladene Datei
                this.init();
            }

            init() {
                lucide.createIcons();
                this.updateStaticText();
                this.setupEventListeners();
            }

            setupEventListeners() {
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');

                ['dragenter', 'dragover'].forEach(t => dropZone.addEventListener(t, (e) => {
                    e.preventDefault();
                    dropZone.classList.add('bg-blue-50', 'border-blue-500');
                }));
                ['dragleave', 'drop'].forEach(t => dropZone.addEventListener(t, (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('bg-blue-50', 'border-blue-500');
                }));

                dropZone.addEventListener('drop', (e) => {
                    if (e.dataTransfer.files.length) this.handleFile(e.dataTransfer.files[0]);
                });
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length) this.handleFile(e.target.files[0]);
                });
            }

            setLanguage(lang) {
                this.lang = lang;
                document.getElementById('btn-de').className =
                    lang === 'de'
                        ? "px-3 py-1.5 rounded-md text-xs font-bold bg-blue-600 text-white shadow-sm"
                        : "px-3 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white hover:bg-slate-700";
                document.getElementById('btn-en').className =
                    lang === 'en'
                        ? "px-3 py-1.5 rounded-md text-xs font-bold bg-blue-600 text-white shadow-sm"
                        : "px-3 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white hover:bg-slate-700";
                this.updateStaticText();
                if (this.currentResult) this.renderResult(this.currentResult);
            }

            updateStaticText() {
                const t = TRANSLATIONS[this.lang];
                document.querySelectorAll('[data-t]').forEach(el => {
                    const key = el.getAttribute('data-t');
                    if (t[key]) el.textContent = t[key];
                });

                // Placeholder f√ºr Chat Input (weil placeholder kein textContent ist)
                const chatInput = document.getElementById('chatbot-input');
                if (chatInput && t.chatPlaceholder) chatInput.placeholder = t.chatPlaceholder;

                // Header Texte (optional ‚Äì falls du es sp√§ter dynamisch willst)
                const headerTitle = document.getElementById('header-title');
                const headerSubtitle = document.getElementById('header-subtitle');
                if (headerTitle && t.headerTitle) headerTitle.textContent = t.headerTitle;
                if (headerSubtitle && t.headerSubtitle) headerSubtitle.textContent = t.headerSubtitle;
            }

            // Nur Datei merken + UI updaten, KEINE Analyse starten
            handleFile(file) {
                if (file.size > 20 * 1024 * 1024) {
                    alert(this.lang === 'de'
                        ? "Datei zu gro√ü (>20MB)."
                        : "File too large (>20MB).");
                    return;
                }

                this.selectedFile = file;

                // Dateiname anzeigen
                const fileInfo = document.getElementById('file-info');
                const fileNameSpan = document.getElementById('file-name');
                fileNameSpan.textContent = file.name;
                fileInfo.classList.remove('hidden');

                // Analyse-Button aktivieren
                const btn = document.getElementById('analyze-btn');
                btn.disabled = false;
                btn.classList.remove('opacity-60', 'cursor-not-allowed', 'bg-blue-400');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }

            // Analyse erst beim Klick auf den Button
            async startAnalysis() {
                if (!this.selectedFile) {
                    alert(this.lang === 'de'
                        ? "Bitte zuerst eine Datei hochladen."
                        : "Please upload a file first.");
                    return;
                }

                const file = this.selectedFile;

                // UI: Loading anzeigen
                document.getElementById('results-container').classList.add('hidden');
                document.getElementById('loading-overlay').classList.remove('hidden');
                document.getElementById('upload-ui').classList.add('hidden');

                const analyzeBtn = document.getElementById('analyze-btn');
                analyzeBtn.disabled = true;
                analyzeBtn.classList.add('opacity-60', 'cursor-not-allowed');

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/analyze', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error("Analysis failed");

                    const data = await response.json();
                    this.currentResult = data.data;
                    this.analysisId = data.analysis_id;
                    this.proofFrame = data.proof_frame || null;

                    // Vorschau erst JETZT setzen
                    const url = URL.createObjectURL(file);
                    const isVideo = file.type.startsWith('video/');
                    if (isVideo) {
                        document.getElementById('result-video').src = url;
                        document.getElementById('result-video').classList.remove('hidden');
                        document.getElementById('result-img').classList.add('hidden');
                    } else {
                        document.getElementById('result-img').src = url;
                        document.getElementById('result-img').classList.remove('hidden');
                        document.getElementById('result-video').classList.add('hidden');
                    }

                    // Upload-Bereich & Intro ausblenden
                    document.getElementById('upload-container').classList.add('hidden');
                    document.getElementById('intro-section').classList.add('hidden');

                    // Proof Frame
                    const proofCard = document.getElementById('proof-card');
                    if (data.proof_frame) {
                        proofCard.classList.remove('hidden');
                        document.getElementById('proof-img').src = `data:image/jpeg;base64,${data.proof_frame}`;
                    } else {
                        proofCard.classList.add('hidden');
                    }

                    this.renderResult(this.currentResult);
                    document.getElementById('results-container').classList.remove('hidden');
                    document.getElementById('loading-overlay').classList.add('hidden');

                    // ‚úÖ Chatbot NUR NACH Analyse sichtbar
                    document.getElementById('chatbot-fab').classList.remove('hidden');
                    openChatbot();

                } catch (error) {
                    console.error(error);
                    alert(this.lang === 'de'
                        ? "Analysefehler. Bitte Server-Logs pr√ºfen."
                        : "Analysis error. Please check server logs.");
                    location.reload();
                }
            }

            computePenalty(result) {
                // Kein Versto√ü -> kein Bu√ügeld
                if (!result || !result.violation_detected) {
                    return {
                        key: "NONE",
                        title: {
                            de: "Kein Versto√ü",
                            en: "No violation"
                        },
                        legal: "",
                        fine: 0,
                        points: 0,
                        banMonths: 0
                    };
                }

                const refs = (result.stvo_references || []).join(" ").toLowerCase();
                const textAll = (
                    (result.violation_title?.de || "") + " " +
                    (result.violation_title?.en || "") + " " +
                    (result.violation_details?.de || "") + " " +
                    (result.violation_details?.en || "")
                ).toLowerCase();

                let selected = OFFENCE_CATALOG.find(o => o.key === "GENERIC");

                // Heuristische Zuordnung nach Paragraphen & Keywords
                if (refs.includes("¬ß3") || textAll.includes("geschwind") || textAll.includes("speed") || textAll.includes("tempo")) {
                    selected = OFFENCE_CATALOG.find(o => o.key === "SPEEDING") || selected;
                } else if (refs.includes("¬ß37") || textAll.includes("ampel") || textAll.includes("red light") || textAll.includes("rotlicht")) {
                    selected = OFFENCE_CATALOG.find(o => o.key === "RED_LIGHT") || selected;
                } else if (refs.includes("¬ß4 stvo") || textAll.includes("abstand")) {
                    selected = OFFENCE_CATALOG.find(o => o.key === "DISTANCE") || selected;
                } else if (refs.includes("¬ß8") || textAll.includes("vorfahrt")) {
                    selected = OFFENCE_CATALOG.find(o => o.key === "RIGHT_OF_WAY") || selected;
                } else if (refs.includes("¬ß26") || textAll.includes("fu√üg√§nger") || textAll.includes("pedestrian")) {
                    selected = OFFENCE_CATALOG.find(o => o.key === "PEDESTRIAN") || selected;
                } else if (refs.includes("¬ß19") || textAll.includes("bahn√ºbergang") || textAll.includes("railway")) {
                    selected = OFFENCE_CATALOG.find(o => o.key === "RAILWAY") || selected;
                } else if (refs.includes("¬ß21a") || textAll.includes("gurt") || textAll.includes("seat belt")) {
                    selected = OFFENCE_CATALOG.find(o => o.key === "SEATBELT") || selected;
                } else if (refs.includes("¬ß23") || textAll.includes("handy") || textAll.includes("phone")) {
                    selected = OFFENCE_CATALOG.find(o => o.key === "MOBILE") || selected;
                }

                return selected;
            }

            renderResult(result) {
                const t = TRANSLATIONS[this.lang];
                const isViolation = result.violation_detected;
                const severity = result.severity;

                // Bu√ügeld berechnen
                this.penalty = this.computePenalty(result);

                // Banner Styling
                const banner = document.getElementById('verdict-banner');
                let color =
                    severity === "CRITICAL" ? "bg-red-600" :
                    severity === "WARNING" ? "bg-amber-500" :
                    severity === "NONE" ? "bg-emerald-500" :
                    "bg-slate-500";
                banner.className = `p-6 flex items-center justify-between ${color} text-white`;

                const iconMap = {
                    "CRITICAL": "alert-octagon",
                    "WARNING": "alert-triangle",
                    "NONE": "check-circle",
                    "UNCLEAR": "help-circle"
                };
                document.getElementById('verdict-icon-container').innerHTML =
                    `<i data-lucide="${iconMap[severity] || 'help-circle'}" class="w-8 h-8"></i>`;
                lucide.createIcons();

                // Texts
                const title = isViolation
                    ? (result.violation_title[this.lang] || t.violationDetected)
                    : t.noViolation;
                document.getElementById('verdict-title').textContent = title;
                const totalPts = (result.penalty_points && result.penalty_points.total) || 0;
                document.getElementById('penalty-points-val').textContent = totalPts;
                document.getElementById('situation-text').textContent = result.situation_summary[this.lang];

                const vBox = document.getElementById('violation-detail-box');
                if (isViolation) {
                    vBox.classList.remove('hidden');
                    document.getElementById('violation-text').textContent = result.violation_details[this.lang];
                } else {
                    vBox.classList.add('hidden');
                }

                // Uncertainty Flags
                const flags = result.uncertainty_flags || [];
                const flagsSection = document.getElementById('uncertainty-flags-section');
                const flagsContainer = document.getElementById('uncertainty-flags-container');
                if (flags.length > 0) {
                    flagsSection.classList.remove('hidden');
                    flagsContainer.innerHTML = flags.map(f => {
                        const label = (f.label && (f.label[this.lang] || f.label.en)) || f.type || 'Unknown';
                        return `<span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-amber-100 text-amber-800 text-sm font-semibold border border-amber-200 shadow-sm">
                            <i data-lucide="alert-triangle" class="w-3.5 h-3.5"></i>
                            ${label}
                        </span>`;
                    }).join('');
                    lucide.createIcons();
                } else {
                    flagsSection.classList.add('hidden');
                    flagsContainer.innerHTML = '';
                }

                // Lists
                const stvoList = document.getElementById('stvo-list');
                stvoList.innerHTML = result.stvo_references && result.stvo_references.length
                    ? result.stvo_references.map(ref =>
                        `<li class="flex items-center gap-2 text-sm font-medium bg-slate-50 p-2 rounded">
                            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full"></div>${ref}
                        </li>`).join('')
                    : `<li class="text-slate-400 italic text-sm">No regs</li>`;

                const signsList = document.getElementById('signs-list');
                const lang = this.lang;

                signsList.innerHTML = result.detected_signs && result.detected_signs.length
                    ? result.detected_signs.map(s => {
                        let nameDe = "";
                        let nameEn = "";

                        if (s.name) {
                            if (typeof s.name === "string") {
                                nameDe = s.name;
                                nameEn = s.name;
                            } else {
                                nameDe = s.name.de || s.name["de-DE"] || "";
                                nameEn = s.name.en || s.name["en-US"] || "";
                            }
                        }

                        let primary, secondary;

                        if (lang === 'de') {
                            // Oben: deutscher Code/Name, unten: Beschreibung
                            primary = s.code || nameDe || nameEn;
                            secondary = nameDe || nameEn;
                        } else {
                            // Englisch: oben die englische Bezeichnung, unten der deutsche Code
                            primary = nameEn || s.code || nameDe;
                            secondary = s.code || "";
                        }

                        const secondaryHtml = secondary
                            ? `<div class="text-slate-600">${secondary}</div>`
                            : "";

                        return `
                            <div class="bg-white p-3 rounded border border-slate-200 text-sm">
                                <div class="font-bold text-slate-800">${primary}</div>
                                ${secondaryHtml}
                            </div>`;
                    }).join('')
                    : `<div class="text-slate-400 text-center text-sm p-4 border-2 border-dashed rounded">${t.noObjects}</div>`;
            }

            downloadPDF() {
                if (!this.currentResult) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: "mm", format: "a4" });

                // Warmes Papier wie deutscher Bescheid
                doc.setFillColor(247, 242, 235);   // leicht warmes Beige
                doc.rect(0, 0, 210, 297, "F");
                doc.setTextColor(20, 20, 20);

                const t = TRANSLATIONS[this.lang];

                const today = new Date();
                const deadline = new Date();
                // Zahlungsfrist 14 Tage
                deadline.setDate(today.getDate() + 14);

                const formatDate = (d) =>
                    this.lang === 'de'
                        ? d.toLocaleDateString('de-DE')
                        : d.toLocaleDateString('en-US');

                const aktenzeichen = this.analysisId
                    ? this.analysisId.substring(0, 10).toUpperCase()
                    : 'AZ-XXXXXX';

                const penalty = this.penalty || {
                    fine: 0,
                    points: 0,
                    banMonths: 0,
                    title: { de: "Kein Versto√ü", en: "No violation" },
                    legal: ""
                };

                const isViolation = this.currentResult.violation_detected;

                // Kopf
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                const headerText = this.lang === 'de'
                    ? "Stadt L√ºneburg ‚Äì Zentrale Bu√ügeldstelle"
                    : "City of L√ºneburg ‚Äì Central Fine Authority";
                doc.text(headerText, 10, 15);

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                const addressText = this.lang === 'de'
                    ? "Am Ochsenmarkt 1 ¬∑ 21335 L√ºneburg"
                    : "Am Ochsenmarkt 1 ¬∑ 21335 L√ºneburg";
                doc.text(addressText, 10, 21);

                // Titel
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                const mainTitle = this.lang === 'de'
                    ? "Bu√ügeldbescheid"
                    : "Penalty Notice";
                doc.text(mainTitle, 105, 35, { align: "center" });

                // Meta
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text((this.lang === 'de' ? "Aktenzeichen: " : "Reference: ") + aktenzeichen, 10, 45);
                doc.text((this.lang === 'de' ? "Datum: " : "Date: ") + formatDate(today), 10, 51);

                // Tatbestand
                let y = 60;
                doc.setFont("helvetica", "bold");
                doc.text(this.lang === 'de' ? "Tatbestand" : "Offence", 10, y);
                y += 6;

                doc.setFont("helvetica", "normal");
                const vt = this.currentResult.violation_title?.[this.lang] || "";
                const vd = this.currentResult.violation_details?.[this.lang] || "";
                const offenceText = isViolation
                    ? (vt ? vt + " ‚Äì " : "") + vd
                    : (this.lang === 'de'
                        ? "Es wurde kein konkreter, bu√ügeldbew√§hrter Versto√ü festgestellt."
                        : "No specific fine-relevant offence was detected.");

                const offenceLines = doc.splitTextToSize(offenceText, 190);
                doc.text(offenceLines, 10, y);
                y += offenceLines.length * 5 + 4;

                // Rechtsgrundlagen
                doc.setFont("helvetica", "bold");
                doc.text(this.lang === 'de' ? "Rechtsgrundlagen" : "Legal basis", 10, y);
                y += 6;
                doc.setFont("helvetica", "normal");

                const refs = this.currentResult.stvo_references || [];
                const refsText = refs.length
                    ? refs.join(", ")
                    : (this.lang === 'de' ? "StVO, Bu√ügeldkatalog" : "StVO, schedule of fines");
                const refLines = doc.splitTextToSize(refsText, 190);
                doc.text(refLines, 10, y);
                y += refLines.length * 5 + 4;

                // Bu√ügeld
                doc.setFont("helvetica", "bold");
                doc.text(this.lang === 'de' ? "Bu√ügeld" : "Fine", 10, y);
                y += 6;
                doc.setFont("helvetica", "normal");

                const fineLabel = this.lang === 'de' ? "Bu√ügeld" : "Fine";

                const fineLine = isViolation
                    ? (
                        (this.lang === 'de'
                            ? `${fineLabel}: ${penalty.fine.toFixed(0)} ‚Ç¨`
                            : `${fineLabel}: ‚Ç¨${penalty.fine.toFixed(0)}`) +
                        (penalty.points
                            ? (this.lang === 'de'
                                ? ` ¬∑ ${penalty.points} Punkt(e) im Fahreignungsregister (Flensburg)`
                                : ` ¬∑ ${penalty.points} point(s) in the German driver registry (Flensburg)`)
                            : "") +
                        (penalty.banMonths
                            ? (this.lang === 'de'
                                ? ` ¬∑ Fahrverbot: ${penalty.banMonths} Monat(e)`
                                : ` ¬∑ Driving ban: ${penalty.banMonths} month(s)`)
                            : "")
                    )
                    : (this.lang === 'de'
                        ? "Kein Bu√ügeld festgesetzt."
                        : "No fine imposed.");
                const fineLines = doc.splitTextToSize(fineLine, 190);
                doc.text(fineLines, 10, y);
                y += fineLines.length * 5 + 4;

                // Zahlungsfrist
                doc.setFont("helvetica", "bold");
                doc.text(this.lang === 'de' ? "Zahlungsfrist" : "Payment deadline", 10, y);
                y += 6;
                doc.setFont("helvetica", "normal");
                const deadlineText = this.lang === 'de'
                    ? `Das Bu√ügeld ist bis sp√§testens ${formatDate(deadline)} auf das unten angegebene Konto zu √ºberweisen.`
                    : `The fine must be paid no later than ${formatDate(deadline)} to the bank account indicated below.`;
                const deadlineLines = doc.splitTextToSize(deadlineText, 190);
                doc.text(deadlineLines, 10, y);
                y += deadlineLines.length * 5 + 4;

                // Bankdaten (IBAN)
                doc.setFont("helvetica", "bold");
                doc.text(this.lang === 'de' ? "Zahlungsempf√§nger" : "Payee", 10, y);
                y += 6;
                doc.setFont("helvetica", "normal");

                const iban = "DE12 3456 7890 1234 5678 90";
                const bic = "LBGHDEFFXXX";
                const empfaenger = this.lang === 'de'
                    ? "Stadt L√ºneburg ‚Äì Zentrale Bu√ügeldstelle"
                    : "City of L√ºneburg ‚Äì Central Fines Office";
                const verwendungszweck = (this.lang === 'de' ? "Verwendungszweck: " : "Reference: ") + aktenzeichen;

                const bankLines = doc.splitTextToSize(
                    (this.lang === 'de'
                        ? `Empf√§nger: ${empfaenger}\nIBAN: ${iban}\nBIC: ${bic}\n${verwendungszweck}`
                        : `Payee: ${empfaenger}\nIBAN: ${iban}\nBIC: ${bic}\n${verwendungszweck}`),
                    190
                );
                doc.text(bankLines, 10, y);
                y += bankLines.length * 5 + 8;

                // Behelfs-Hinweis (kurz)
                const hintTitle = this.lang === 'de' ? "Rechtsbehelf" : "Legal remedy";
                doc.setFont("helvetica", "bold");
                doc.text(hintTitle, 10, y);
                y += 6;
                doc.setFont("helvetica", "normal");
                const hintText = this.lang === 'de'
                    ? "Gegen diesen Bescheid k√∂nnen Sie innerhalb von zwei Wochen nach Zustellung schriftlich oder zur Niederschrift bei der oben genannten Beh√∂rde Einspruch einlegen."
                    : "You may lodge an objection in writing with the authority named above within two weeks after service of this notice.";
                const hintLines = doc.splitTextToSize(hintText, 190);
                doc.text(hintLines, 10, y);
                y += hintLines.length * 5 + 8;

                // Beweisfoto einf√ºgen (wenn vorhanden)
                if (this.proofFrame) {
                    try {
                        const imgData = "data:image/jpeg;base64," + this.proofFrame;
                        // Platz lassen falls wir sehr weit unten sind
                        if (y > 220) {
                            doc.addPage();
                            // Hintergrund auch auf neuer Seite
                            doc.setFillColor(247, 242, 235);
                            doc.rect(0, 0, 210, 297, "F");
                            doc.setTextColor(20, 20, 20);
                            y = 20;
                        }
                        doc.setFont("helvetica", "bold");
                        doc.text(this.lang === 'de' ? "Beweisfoto" : "Evidence photo", 10, y);
                        y += 4;

                        doc.addImage(imgData, "JPEG", 10, y + 2, 90, 60); // einfache Gr√∂√üe
                    } catch (e) {
                        console.warn("Could not add proof image to PDF:", e);
                    }
                }

                const filename = this.lang === 'de'
                    ? `Bussgeldbescheid_${aktenzeichen}.pdf`
                    : `PenaltyNotice_${aktenzeichen}.pdf`;
                doc.save(filename);
            }

            openAppealModal() {
                const modal = document.getElementById('appeal-modal');
                const textField = document.getElementById('appeal-text');

                const date = new Date().toLocaleDateString(this.lang === 'de' ? 'de-DE' : 'en-US');
                const ref = this.analysisId ? this.analysisId.substring(0, 8).toUpperCase() : 'XXXX';
                const violation = (this.currentResult &&
                    this.currentResult.violation_title &&
                    this.currentResult.violation_title[this.lang]) || "";

                if (this.lang === 'de') {
                    textField.innerText =
                        `Sehr geehrte Damen und Herren,\n\n` +
                        `hiermit lege ich fristgerecht Widerspruch gegen den Vorwurf "${violation}" (Aktenzeichen: ${ref}) vom ${date} ein.\n\n` +
                        `Begr√ºndung:\n` +
                        `Nach Pr√ºfung der Sachlage und der vorliegenden Beweismittel bin ich der Ansicht, dass der Sachverhalt nicht korrekt bewertet wurde. ` +
                        `Insbesondere ist die Situation nicht eindeutig erkennbar bzw. es lagen mildernde Umst√§nde vor.\n\n` +
                        `Ich bitte um erneute Pr√ºfung des Vorgangs.\n\n` +
                        `Mit freundlichen Gr√º√üen,\n[Ihr Name]`;
                } else {
                    textField.innerText =
                        `To whom it may concern,\n\n` +
                        `I hereby formally object to the accusation of "${violation}" (Ref: ${ref}) dated ${date}.\n\n` +
                        `Reasoning:\n` +
                        `Upon reviewing the evidence, I believe the situation has been misinterpreted. ` +
                        `In particular, the circumstances were unclear and/or mitigating factors were present.\n\n` +
                        `I kindly request a re-evaluation of the case.\n\n` +
                        `Sincerely,\n[Your Name]`;
                }

                modal.classList.remove('hidden');
            }

            closeAppealModal() {
                document.getElementById('appeal-modal').classList.add('hidden');
            }

            copyAppeal() {
                const text = document.getElementById('appeal-text').innerText;
                navigator.clipboard.writeText(text).then(() => {
                    if (this.lang === 'de') {
                        alert("Text in die Zwischenablage kopiert.");
                    } else {
                        alert("Text copied to clipboard.");
                    }
                });
            }

            downloadAppealPDF() {
                const content = document.getElementById('appeal-text').innerText || "";
                if (!content.trim()) return;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: "mm", format: "a4" });

                // Warmes Papier
                doc.setFillColor(247, 242, 235);
                doc.rect(0, 0, 210, 297, "F");
                doc.setTextColor(20, 20, 20);

                const today = new Date();
                const formatDate = (d) =>
                    this.lang === 'de'
                        ? d.toLocaleDateString('de-DE')
                        : d.toLocaleDateString('en-US');

                const aktenzeichen = this.analysisId
                    ? this.analysisId.substring(0, 10).toUpperCase()
                    : 'AZ-XXXXXX';

                // Titel
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                const title = this.lang === 'de'
                    ? "Widerspruch gegen Bu√ügeldbescheid"
                    : "Objection against penalty notice";
                doc.text(title, 10, 20);

                // Meta
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text((this.lang === 'de' ? "Aktenzeichen: " : "Reference: ") + aktenzeichen, 10, 28);
                doc.text((this.lang === 'de' ? "Datum: " : "Date: ") + formatDate(today), 10, 34);
                doc.text(this.lang === 'de' ? "Absender: [Ihr Name, Anschrift]" : "Sender: [Your name, address]", 10, 40);

                // Text
                doc.setFontSize(11);
                let y = 50;
                const lines = doc.splitTextToSize(content, 190);
                doc.text(lines, 10, y);

                const filename = this.lang === 'de'
                    ? `Widerspruch_${aktenzeichen}.pdf`
                    : `Objection_${aktenzeichen}.pdf`;
                doc.save(filename);
            }

            reset() {
                location.reload();
            }
        }

        /* ==========================
           ü§ñ Chatbot JS (NEU)
        ========================== */

        function openChatbot() {
            const panel = document.getElementById('chatbot-container');
            const fab = document.getElementById('chatbot-fab');
            if (panel) panel.classList.remove('hidden');
            if (fab) fab.classList.add('hidden');
        }

        function minimizeChatbot() {
            const panel = document.getElementById('chatbot-container');
            const fab = document.getElementById('chatbot-fab');
            if (panel) panel.classList.add('hidden');
            if (fab) fab.classList.remove('hidden');
        }

        function closeChatbot() {
            // close = minimieren + button bleibt
            minimizeChatbot();
        }

function stripMarkdownStars(s) {
  return (s || "").replace(/\*+/g, "");
}

function appendChatMessage(role, text) {
  const box = document.getElementById('chatbot-messages');
  if (!box) return null;

  const wrap = document.createElement('div');
  wrap.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';

  const bubble = document.createElement('div');
  bubble.className = role === 'user'
    ? 'max-w-[85%] bg-blue-600 text-white px-3 py-2 rounded-2xl rounded-br-md shadow'
    : 'max-w-[85%] bg-white border border-slate-200 text-slate-800 px-3 py-2 rounded-2xl rounded-bl-md shadow-sm';

  bubble.textContent = stripMarkdownStars(text);

  wrap.appendChild(bubble);
  box.appendChild(wrap);
  box.scrollTop = box.scrollHeight;
  return bubble;
}


async function sendChatbotMessage() {
    const input = document.getElementById('chatbot-input');
    const text = (input?.value || "").trim();
    if (!text) return;

    appendChatMessage('user', text);
    input.value = "";

    const typing = appendChatMessage(
        'bot',
        inspector.lang === 'de'
            ? "Einen Moment‚Ä¶ ich pr√ºfe das anhand deiner Analyse."
            : "One moment‚Ä¶ I‚Äôm checking this based on your analysis."
    );

    try {
        const res = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                analysis_id: inspector.analysisId, // ‚úÖ korrekt
                message: text,                     // ‚úÖ korrekt
            })
        });

        const data = await res.json();

        if (!res.ok) {
            throw new Error(data.error || "Chat failed");
        }

const reply = data.reply || (
    inspector.lang === 'de'
        ? "Keine Antwort erhalten."
        : "No answer received."
);

typing.textContent = stripMarkdownStars(reply).replace(/\s+/g, " ").trim();


    } catch (e) {
        console.error(e);
        typing.textContent = inspector.lang === 'de'
            ? "Fehler beim Chat. Siehe Konsole."
            : "Chat error. See console.";
    }
}


        const inspector = new TrafficInspector();
    </script>
</body>
</html>
